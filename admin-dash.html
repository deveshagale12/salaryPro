<!DOCTYPE html>

<html lang="en">

<head>

<meta charset="UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>SalaryPro | Admin Dashboard</title>



<link

    href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap"

    rel="stylesheet">

<link

    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"

    rel="stylesheet">

<link rel="stylesheet"

    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">



<style>

:root {

    --sidebar-bg: #0f172a;

    --accent: #10b981;

    --primary: #6366f1;

    --bg-body: #f8fafc;

}



body {

    font-family: 'Plus Jakarta Sans', sans-serif;

    background-color: var(--bg-body);

    color: #1e293b;

    margin: 0;

}



/* Sidebar Styling */

.sidebar {

    width: 260px;

    background: var(--sidebar-bg);

    min-height: 100vh;

    position: fixed;

    z-index: 1000;

    padding: 2rem 1rem;

    transition: 0.3s;

}



.nav-link {

    color: #94a3b8;

    padding: 0.8rem 1rem;

    border-radius: 10px;

    margin-bottom: 0.5rem;

    display: flex;

    align-items: center;

    text-decoration: none;

    transition: 0.2s;

}



.nav-link:hover, .nav-link.active {

    background: rgba(255, 255, 255, 0.1);

    color: #fff !important;

}



.nav-link.active {

    border-left: 4px solid var(--accent);

}



/* Main Content */

.main-content {

    margin-left: 260px;

    padding: 2rem;

    min-height: 100vh;

}



/* Card & Table Styling */

.glass-card {

    background: #fff;

    border-radius: 16px;

    border: 1px solid #e2e8f0;

    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);

    overflow: hidden;

}



.stat-card {

    background: linear-gradient(135deg, var(--primary), #4f46e5);

    color: white;

    padding: 1.5rem;

    border-radius: 16px;

    border: none;

}



.table thead th {

    background: #f8fafc;

    font-size: 0.75rem;

    text-transform: uppercase;

    letter-spacing: 0.05em;

    padding: 1rem;

    color: #64748b;

}



/* Action Buttons */

.btn-action {

    width: 32px;

    height: 32px;

    border-radius: 8px;

    display: inline-flex;

    align-items: center;

    justify-content: center;

    padding: 0;

    transition: 0.2s;

}



/* Mobile View Enhancements */

@media ( max-width : 991px) {

    .sidebar {

        width: 100%;

        min-height: auto;

        height: 70px; /* Fixed height for consistency */

        bottom: 0;

        top: auto;

        flex-direction: row !important;

        padding: 5px;

        position: fixed;

        justify-content: space-around;

        border-top: 1px solid rgba(255, 255, 255, 0.1);

    }

    .sidebar h4, .logout-wrapper {

        display: none !important;

    }

    .nav {

        flex-direction: row !important;

        width: 100%;

        justify-content: space-around;

        align-items: center;

    }

    .nav-link {

        flex-direction: column;

        font-size: 0.65rem;

        padding: 5px;

        margin-bottom: 0;

        text-align: center;

    }

    .nav-link i {

        margin-right: 0 !important;

        font-size: 1.2rem;

    }

    .main-content {

        margin-left: 0 !important;

        padding: 1rem;

        padding-bottom: 85px; /* Leave space for bottom nav */

    }

}



.table-responsive {

    overflow-x: auto;

    -webkit-overflow-scrolling: touch;

}



/* Make sure modal fits on small screens */

.modal-dialog {

    margin: 10px;

}



@media print {

    /* Hide everything on the page */

    body * {

        visibility: hidden;

    }

    /* Show only the receipt and its children */

    #printableReceipt, #printableReceipt * {

        visibility: visible;

    }

    #printableReceipt {

        position: absolute;

        left: 0;

        top: 0;

        width: 100%;

        border: none !important;

    }

    .no-print {

        display: none !important;

    }

}

/* Styling for a professional feel */

#employeeSection {

    color: #334155;

}



.animate-row {

    transition: all 0.2s;

}



.animate-row:hover {

    background-color: #f1f5f9 !important;

    transform: scale(1.002);

}



.fw-600 {

    font-weight: 600;

}



.bg-primary-subtle {

    background-color: #e0e7ff;

}



.bg-danger-subtle {

    background-color: #fee2e2;

}



.table thead th {

    font-weight: 700;

    text-transform: uppercase;

    font-size: 0.75rem;

    letter-spacing: 0.5px;

    color: #64748b;

}



@media ( max-width : 576px) {

    .btn-sm {

        padding: 0.5rem 0.75rem; /* Larger tap targets */

        font-size: 0.8rem;

    }

    .stat-card h2 {

        font-size: 1.5rem;

    }

}

/* Force Modal to Center and add smooth entry */

.modal-dialog {

    margin: 1.75rem auto; /* 'auto' horizontally centers it */

    display: flex;

    align-items: center;

    min-height: calc(100% - 3.5rem);

}



/* Optional: Make the popup look modern */

.modal-content {

    border: none;

    border-radius: 15px;

    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);

}

@media (max-width: 991px) {

    .sidebar {

        width: 100%;

        height: 75px; /* Increased slightly for tap comfort */

        bottom: 0;

        top: auto;

        flex-direction: row !important;

        padding: 0; /* Remove padding to maximize space */

        position: fixed;

        justify-content: space-around;

        background: var(--sidebar-bg);

        border-top: 1px solid rgba(255, 255, 255, 0.1);

    }



    /* Keep the wrapper hidden, but the individual nav-link will show */

    .sidebar h4, .logout-wrapper {

        display: none !important;

    }



    .nav {

        flex-direction: row !important;

        width: 100%;

        justify-content: space-evenly;

        align-items: center;

    }



    .nav-link {

        flex-direction: column;

        font-size: 0.6rem; /* Slightly smaller text to fit 5 items */

        padding: 8px 5px;

        margin-bottom: 0;

        text-align: center;

        flex: 1; /* Give each item equal width */

    }



    .nav-link i {

        margin-right: 0 !important;

        font-size: 1.1rem;

        margin-bottom: 2px;

    }

}

</style>

</head>

<body>



    <div class="sidebar d-flex flex-column no-print">

        <h4 class="text-white fw-bold mb-5 px-3">SalaryPro</h4>

        <nav class="nav flex-column h-100">

            <a class="nav-link active" id="btn-emp"

                onclick="showSection('employeeSection')"> <i

                class="bi bi-people fs-5 me-2"></i> Employees

            </a> <a class="nav-link" id="btn-logs"

                onclick="showSection('logsSection')"> <i

                class="bi bi-journal-text fs-5 me-2"></i> History Logs

            </a> <a class="nav-link" id="btn-users"

                onclick="showSection('userManagementSection')"> <i

                class="bi bi-person-gear fs-5 me-2"></i> User Management

            </a>

            <a class="nav-link d-lg-none text-danger" onclick="logout()">

        <i class="bi bi-box-arrow-right fs-5 me-2"></i> Logout

    </a>

            <div class="mt-auto logout-wrapper px-3">

                <button class="btn btn-outline-danger w-100" onclick="logout()">Logout</button>

            </div>

        </nav>

    </div>



    <div class="main-content">



        <div id="employeeSection" class="p-4">

    <div class="row mb-4">

                <div class="col-12">

                    <div class="card border-0 shadow-sm rounded-4 p-4">

                        <div class="d-flex align-items-center mb-3">

                            <div

                                class="bg-primary bg-opacity-10 p-2 rounded-3 me-3 text-primary">

                                <i class="bi bi-megaphone-fill fs-4"></i>

                            </div>

                            <div>

                                <h5 class="fw-bold mb-0">Post Global Announcement</h5>

                                <small class="text-muted">This will be visible to all

                                    staff on their dashboards.</small>

                            </div>

                        </div>



                        <div class="row g-2">

                            <div class="col-md-10">

                                <textarea id="noticeInput" class="form-control border-2"

                                    rows="2"

                                    placeholder="Type your message here (e.g., Office closed on Monday)..."></textarea>

                            </div>

                            <div class="col-md-2 d-flex flex-column gap-2">

                                <button class="btn btn-primary h-100 fw-bold"

                                    onclick="updateNotice()">

                                    <i class="bi bi-send-fill me-1"></i> Post

                                </button>

                                <button class="btn btn-outline-danger btn-sm"

                                    onclick="clearNotice()">Clear</button>

                            </div>

                        </div>

                        <div id="adminNoticeStatus" class="small mt-2"></div>

                    </div>

                </div>

            </div>

            <div class="d-flex justify-content-between align-items-center mb-4">

                <h2 class="fw-bold m-0 text-dark">Staff Payroll</h2>

                <button class="btn btn-success shadow-sm"

                    onclick="exportEmployeeReport()">

                    <i class="bi bi-file-earmark-excel me-2"></i>Export Excel

                </button>

            </div>



            <div class="row g-3 mb-4">

                <div class="col-md-6">

                    <div class="card border-0 shadow-sm p-3">

                        <small class="text-muted d-block">Total Personnel</small>

                        <h2 id="totalEmp" class="fw-bold mb-0">0</h2>

                    </div>

                </div>

                <div class="col-md-6">

                    <div class="card border-0 shadow-sm p-3">

                        <small class="text-muted d-block">Pending Advance Total</small>

                        <h2 id="totalAdvanceAmt" class="fw-bold mb-0">₹0</h2>

                    </div>

                </div>

            </div>



            <div class="card shadow-sm rounded-4 overflow-hidden">

                <div class="table-responsive">

                    <table class="table align-middle">

                        <thead class="table-light">

                            <tr>

                                <th class="ps-4">Staff Details</th>

                                <th>Earnings (Cr)</th>

                                <th>Advance (Dr)</th>

                                <th>Net Balance</th>

                                <th class="text-center">Actions</th>

                            </tr>

                        </thead>

                        <tbody id="employeeTableBody">

                        </tbody>

                    </table>

                </div>

            </div><br><br>

            <div class="card p-4 border-0 shadow-sm rounded-4">

    <h5 class="fw-bold mb-3">Home Content Editor</h5>

    

    <input type="text" id="adminHeroTitle" class="form-control mb-2" placeholder="Main Header Title">

    <textarea id="adminHeroSubtitle" class="form-control mb-3" placeholder="Sub-header description"></textarea>



<label class="fw-bold small mt-2">About Section Description</label>

<textarea id="adminAboutText" class="form-control mb-3" rows="4" placeholder="Describe your company..."></textarea>

    <div class="row mb-3">

        <div class="col-6">

            <img id="prev1" src="/api/home/photo/banner1.jpg" class="img-thumbnail mb-1">

            <input type="file" id="adminFile1" onchange="previewImage(this, 'prev1')" class="form-control form-control-sm">

        </div>

        <div class="col-6">

            <img id="prev2" src="/api/home/photo/banner2.jpg" class="img-thumbnail mb-1">

            <input type="file" id="adminFile2" onchange="previewImage(this, 'prev2')" class="form-control form-control-sm">

        </div>

    </div>



    <button id="uploadBtn" onclick="uploadHomeMedia()" class="btn btn-primary w-100 rounded-pill">Update Everything</button>

</div>    

        </div>

        <div id="userManagementSection" class="d-none">

            <div class="d-flex justify-content-between align-items-center mb-4">

                <h2 class="fw-bold m-0 text-dark">User Management</h2>

                <button class="btn btn-primary shadow-sm" onclick="openUserModal()">

                    <i class="bi bi-person-plus me-2"></i>Add New User

                </button>

            </div>



            <div class="card shadow-sm rounded-4 overflow-hidden">

                <div class="table-responsive">

                    <table class="table align-middle">

                        <thead class="table-light">

                            <tr>

                                <th class="ps-4">Name</th>

                                <th>Email</th>

                                <th>Role</th>

                                <th class="text-center">Actions</th>

                            </tr>

                        </thead>

                        <tbody id="userTableBody">

                        </tbody>

                    </table>

                </div>

            </div>

        </div>

        <div id="logsSection" class="d-none">

            <div class="row mb-4 align-items-center">

                <div class="col-md-5">

                    <h2 class="fw-bold m-0">

                        <i class="bi bi-clock-history me-2"></i>Audit Trail

                    </h2>

                    <p class="text-muted small">Comprehensive ledger of all

                        financial movements.</p>

                </div>

                <div class="col-md-7 d-flex justify-content-md-end gap-2">

                    <input type="text" id="logSearch"

                        class="form-control w-auto shadow-sm"

                        placeholder="Search name or note..." onkeyup="filterLogTable()">



                    <div class="input-group w-auto shadow-sm">

                        <span class="input-group-text bg-white"><i

                            class="bi bi-calendar3"></i></span> <input type="month"

                            id="logMonthFilter" class="form-control"

                            onchange="fetchFilteredLogs()">

                    </div>



                    <button class="btn btn-success shadow-sm"

                        onclick="exportLogsToExcel()">

                        <i class="bi bi-file-earmark-excel"></i> Export

                    </button>

                </div>

            </div>



            <div class="row g-3 mb-4">

                <div class="col-md-4">

                    <div

                        class="p-3 bg-white border rounded-4 shadow-sm border-start border-success border-4">

                        <div class="text-muted small fw-bold text-uppercase">Total

                            Credits (Salary)</div>

                        <h3 id="monthCredits" class="fw-bold text-success mt-1">₹0</h3>

                    </div>

                </div>

                <div class="col-md-4">

                    <div

                        class="p-3 bg-white border rounded-4 shadow-sm border-start border-warning border-4">

                        <div class="text-muted small fw-bold text-uppercase">Total

                            Debits (Adv/Pay)</div>

                        <h3 id="monthDebits" class="fw-bold text-warning mt-1">₹0</h3>

                    </div>

                </div>

                <div class="col-md-4">

                    <div

                        class="p-3 bg-white border rounded-4 shadow-sm border-start border-primary border-4">

                        <div class="text-muted small fw-bold text-uppercase">Net

                            Cash Outflow</div>

                        <h3 id="netOutflow" class="fw-bold text-primary mt-1">₹0</h3>

                    </div>

                </div>

            </div>



            <div class="card shadow-sm rounded-4 overflow-hidden">

                <div class="table-responsive">

                    <table class="table align-middle">

                        <thead class="bg-light">

                            <tr>

                                <th class="ps-4">Timestamp</th>

                                <th>Personnel</th>

                                <th>Type</th>

                                <th>Amount</th>

                                <th>Method/Note</th>

                                <th class="text-center">Action</th>

                            </tr>

                        </thead>

                        <tbody id="logsTableBody"></tbody>

                    </table>

                </div>

            </div>

        </div>

    </div>

    <div class="modal fade" id="fundModal" tabindex="-1" aria-hidden="true">

        <div class="modal-dialog modal-dialog-centered">

            <div class="modal-content border-0 shadow-lg"

                style="border-radius: 1.2rem;">

                <div class="modal-header border-0 pb-0">

                    <h5 class="modal-title fw-bold" id="modalTitle">Account Update</h5>

                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>

                </div>

                <div class="modal-body p-4">



                    <form id="fundForm">

                        <input type="hidden" id="targetUserId"> <input

                            type="hidden" id="transactionType">

                        <div class="mb-3">

                            <label class="small fw-bold text-muted">Employee</label> <input

                                type="text" id="targetUserName"

                                class="form-control bg-light border-0" readonly>

                        </div>

                        <div class="mb-3">

                            <label class="small fw-bold text-muted">Amount (₹)</label> <input

                                type="number" id="fundAmount" class="form-control border-2"

                                placeholder="0.00">

                        </div>

                        <div class="mb-3">

                            <label class="small fw-bold text-muted">Note</label>

                            <textarea id="workNote" class="form-control border-2" rows="2"></textarea>

                        </div>

                        <button type="button" class="btn btn-primary w-100 fw-bold py-2"

                            onclick="submitFund()">Confirm</button>

                    </form>



                    <div id="paymentOptionsSection" class="d-none">

                        <div class="text-center mb-4">

                            <h2 class="fw-bold text-primary" id="netPayDisplay">₹0</h2>

                            <p class="text-muted small">Pending Settlement Amount</p>

                        </div>

                        <div class="d-grid gap-2">

                            <button class="btn btn-outline-primary py-3 text-start"

                                onclick="window.processFinalPayment('ONLINE')">

                                <i class="bi bi-bank me-2"></i> Online Transfer / UPI

                            </button>

                            <button class="btn btn-outline-secondary py-3 text-start"

                                onclick="window.processFinalPayment('CASH')">

                                <i class="bi bi-cash-stack me-2"></i> Cash Payment

                            </button>

                        </div>

                    </div>



                    <div id="receiptContent" class="d-none"></div>



                </div>

            </div>

        </div>

    </div>

    <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">

        <div class="modal-dialog modal-dialog-centered">

            <div class="modal-content border-0 shadow-lg"

                style="border-radius: 1.2rem;">

                <div class="modal-header border-0">

                    <h5 class="modal-title fw-bold" id="userModalTitle">User

                        Details</h5>

                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>

                </div>

                <div class="modal-body p-4">

                    <form id="userForm">

                        <input type="hidden" id="manageUserId">

                        <div class="mb-3">

                            <label class="small fw-bold text-muted">Full Name</label> <input

                                type="text" id="manageUserName" class="form-control border-2"

                                required>

                        </div>

                        <div class="mb-3">

                            <label class="small fw-bold text-muted">Email</label> <input

                                type="email" id="manageUserEmail" class="form-control border-2"

                                required>

                        </div>

                        <div class="mb-3">

                            <label class="small fw-bold text-muted">Role</label> <select

                                id="manageUserRole" class="form-select border-2">

                                <option value="USER">USER</option>

                                <option value="ADMIN">ADMIN</option>

                            </select>

                        </div>

                        <button type="submit" class="btn btn-primary w-100 fw-bold py-2">Save

                            User</button>

                    </form>

                </div>

            </div>

        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script

        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>



    <script

        src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.min.js"></script>

    <script

        src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>



    <script

        src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <script>

    // Check if user is logged in

    // TOP OF SCRIPT FIX



    async function refreshDataOnly() {

        const userData = localStorage.getItem('user');

        if(!userData) return;

        const user = JSON.parse(userData);



        try {

            const res = await fetch(`/api/salary/my-summary/${user.id}`);

            if (res.ok) {

                const data = await res.json();

                

                // Refresh Stats

                document.getElementById('total').innerText = `₹${(data.totalEarned || 0).toLocaleString('en-IN')}`;

                document.getElementById('advance').innerText = `₹${(data.advanceTaken || 0).toLocaleString('en-IN')}`;

                document.getElementById('net').innerText = `₹${(data.netPayable || 0).toLocaleString('en-IN')}`;



                // Refresh Table & Chart

                if(data.dailyRecords) {

                    populateTable(data.dailyRecords);

                    renderChart(data.dailyRecords);

                }

                

                // Also check for new notices

                await fetchNotice();

                

                console.log("Dashboard auto-refreshed at: " + new Date().toLocaleTimeString());

            }

        } catch(e) { 

            console.error("Auto-refresh failed:", e); 

        }

        document.getElementById('refreshStatus').innerText = `Last updated: ${new Date().toLocaleTimeString()}`;

    }



    let globalSalaryModal;

    let globalUserModal;



    window.onload = function() {

        // Initialize Salary Modal

        const salaryModalElem = document.getElementById('fundModal');

        if (salaryModalElem) {

            globalSalaryModal = new bootstrap.Modal(salaryModalElem);

        }



        // Initialize User Modal

        const userModalElem = document.getElementById('userModal');

        if (userModalElem) {

            globalUserModal = new bootstrap.Modal(userModalElem);

        }



        // Initial Data Load

        loadEmployees();

    };

    async function loadAllUsers() {

        const tbody = document.getElementById('userTableBody');

        try {

            const res = await fetch('/api/users/all');

            const users = await res.json();

            

            tbody.innerHTML = users.map(u => `

                <tr>

                    <td class="ps-4 fw-bold">${u.name}</td>

                    <td>${u.email}</td>

                    <td><span class="badge ${u.role === 'ADMIN' ? 'bg-dark' : 'bg-info'}">${u.role}</span></td>

                    <td class="text-center">

                        <button class="btn btn-sm btn-outline-primary me-2" onclick="editUser(${u.id}, '${u.name}', '${u.email}', '${u.role}')">

                            <i class="bi bi-pencil"></i>

                        </button>

                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${u.id})">

                            <i class="bi bi-trash"></i>

                        </button>

                    </td>

                </tr>

            `).join('');

        } catch (err) { console.error("Error loading users", err); }

    }

    // 1. DATA FETCHING

    async function loadEmployees() {

        const tbody = document.getElementById('employeeTableBody');

        if (!tbody) return;



        try {

            const res = await fetch('/api/users/all');

            const users = await res.json();

            const userList = users.filter(u => u.role === 'USER' || u.role === 'ROLE_USER');

            

            const totalEmpEl = document.getElementById('totalEmp');

            if (totalEmpEl) totalEmpEl.innerText = userList.length;



            let totalAdv = 0;



            tbody.innerHTML = userList.map(u => {

                const earned = u.totalEarned || 0;

                const advance = u.advanceAmount || 0;

                const net = earned - advance;

                totalAdv += advance;



                return `

                <tr>

                    <td class="ps-4">

                        <div class="fw-bold">${u.name}</div>

                        <div class="text-muted small">${u.email}</div>

                    </td>

                    <td class="text-success fw-bold">₹${earned.toLocaleString()}</td>

                    <td class="text-danger fw-bold">₹${advance.toLocaleString()}</td>

                    <td><span class="badge bg-primary px-3 py-2">₹${net.toLocaleString()}</span></td>

                    <td class="text-center">

                        <div class="d-flex justify-content-center gap-2">

                            <button class="btn btn-sm btn-outline-success" onclick="window.openSalaryModal(${u.id}, '${u.name}', 'SALARY')">+ Salary</button>

                            <button class="btn btn-sm btn-outline-warning" onclick="window.openSalaryModal(${u.id}, '${u.name}', 'ADVANCE')">- Adv</button>

                            <button class="btn btn-sm btn-dark" onclick="window.initiatePayment(${u.id}, '${u.name}')">Payment</button>

                        </div>

                    </td>

                </tr>`;

            }).join('');



            const advEl = document.getElementById('totalAdvanceAmt');

            if (advEl) advEl.innerText = `₹${totalAdv.toLocaleString()}`;



        } catch (err) {

            console.error("Fetch Error:", err);

            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger p-4">Error loading data.</td></tr>';

        }

    }



    // 2. SALARY & ADVANCE MODAL OPENING

    function openUserModal() {

    document.getElementById('userForm').reset();

    document.getElementById('manageUserId').value = "";

    document.getElementById('userModalTitle').innerText = "Add New User";

    globalUserModal.show();

}

    window.openSalaryModal = function(id, name, type) {

        document.getElementById('fundForm').classList.remove('d-none');

        document.getElementById('paymentOptionsSection').classList.add('d-none');

        document.getElementById('receiptContent').classList.add('d-none');

        

        document.getElementById('targetUserId').value = id;

        document.getElementById('targetUserName').value = name;

        document.getElementById('transactionType').value = type;

        document.getElementById('fundAmount').value = "";

        document.getElementById('workNote').value = "";

        

        document.getElementById('modalTitle').innerText = type === 'SALARY' ? 'Add Earnings' : 'Record Advance';

        

        if (globalSalaryModal) globalSalaryModal.show();

    };

    function editUser(id, name, email, role) {

        document.getElementById('manageUserId').value = id;

        document.getElementById('manageUserName').value = name;

        document.getElementById('manageUserEmail').value = email;

        document.getElementById('manageUserRole').value = role;

        document.getElementById('userModalTitle').innerText = "Edit User";

        globalUserModal.show();

    }



    // 3. Save User (Create or Update)

   document.getElementById('userForm').onsubmit = async function(e) {

    e.preventDefault();

    const id = document.getElementById('manageUserId').value;

    const userData = {

        name: document.getElementById('manageUserName').value,

        email: document.getElementById('manageUserEmail').value,

        role: document.getElementById('manageUserRole').value

    };



    // Use /register for new users, and just /api/users/{id} for updates

    const url = id ? `/api/users/${id}` : '/api/users/register';

    const method = id ? 'PUT' : 'POST';



    try {

        const res = await fetch(url, {

            method: method,

            headers: { 'Content-Type': 'application/json' },

            body: JSON.stringify(userData)

        });

        

        if (res.ok) {

            globalUserModal.hide();

            loadAllUsers(); // Refresh management table

            loadEmployees(); // Refresh payroll table

        } else {

            const error = await res.text();

            alert("Server Error: " + error);

        }

    } catch (err) {

        alert("Connection failed.");

    }

};



//DELETE USER

async function deleteUser(id) {

    if (!confirm("Are you sure? This will delete all salary records for this user too.")) return;

    try {

        // Matches @DeleteMapping("/{id}")

        const res = await fetch(`/api/users/${id}`, { method: 'DELETE' });

        if (res.ok) {

            loadAllUsers();

            loadEmployees();

        }

    } catch (err) {

        alert("Error deleting user.");

    }

}





    // 3. SUBMIT SALARY OR ADVANCE

    async function submitFund() {

        const id = document.getElementById('targetUserId').value;

        const amt = document.getElementById('fundAmount').value;

        const note = document.getElementById('workNote').value;

        const type = document.getElementById('transactionType').value;



        if(!amt || amt <= 0) return alert("Please enter a valid amount");



        const endpoint = type === 'SALARY' ? '/api/salary/add' : '/api/salary/advance';

        const url = `${endpoint}?userId=${id}&amount=${amt}&note=${encodeURIComponent(note)}`;



        try {

            const res = await fetch(url, { method: 'POST' });

            if(res.ok) {

                globalSalaryModal.hide(); // Corrected variable

                loadEmployees();

            } else {

                alert("Error: Server rejected the transaction.");

            }

        } catch (err) {

            alert("Network error.");

        }

    }



    // 4. INITIATE FINAL PAYMENT (SETTLEMENT)

    window.initiatePayment = async function(userId, name) {

        try {

            const res = await fetch(`/api/salary/my-summary/${userId}`);

            const data = await res.json();

            

            if(data.netPayable <= 0) return alert("No pending balance to pay for " + name);



            document.getElementById('modalTitle').innerText = "Process Payment";

            document.getElementById('fundForm').classList.add('d-none');

            document.getElementById('paymentOptionsSection').classList.remove('d-none');

            document.getElementById('receiptContent').classList.add('d-none');

            

            document.getElementById('netPayDisplay').innerText = `₹${data.netPayable.toLocaleString()}`;

            document.getElementById('targetUserId').value = userId;

            document.getElementById('targetUserName').value = name;



            globalSalaryModal.show();

        } catch (e) {

            alert("Failed to fetch balance.");

        }

    };

    async function fetchCurrentNotice() {

        try {

            const res = await fetch('/api/admin/notice');

            const data = await res.json(); // Convert raw text to a JavaScript Object

            

            // Show only the 'content' part in the textarea

            if (data && data.content) {

                document.getElementById('noticeInput').value = data.content;

                document.getElementById('adminNoticeStatus').innerText = "Currently showing: " + data.content;

            }

        } catch (e) { console.log("No notice set yet."); }

    }

    

    async function fetchNotice() {

        try {

            const res = await fetch('/api/admin/notice');

            if (!res.ok) return;



            let data = await res.json();



            // Check if data is still a string (sometimes happens with certain backend configs)

            if (typeof data === 'string') {

                data = JSON.parse(data);

            }



            // Only proceed if we have valid content

            if (data && data.content && data.content.trim() !== "") {

                const container = document.getElementById('noticeContainer');

                const textElement = document.getElementById('adminNoticeText');

                const timeElement = document.getElementById('noticeTime');



                if (container && textElement) {

                    container.classList.remove('d-none');

                    

                    // CRITICAL: Explicitly grab the .content property

                    textElement.innerText = data.content; 

                    

                    if (timeElement && data.timestamp) {

                        timeElement.innerText = data.timestamp;

                    }

                }

            } else {

                document.getElementById('noticeContainer').classList.add('d-none');

            }

        } catch (e) {

            console.error("Notice parsing failed:", e);

            // If it fails, hide the box so the user doesn't see the error

            document.getElementById('noticeContainer').classList.add('d-none');

        }

    }

    

    async function updateNotice() {

        const msg = document.getElementById('noticeInput').value;

        const statusEl = document.getElementById('adminNoticeStatus');

        

        if (!msg.trim()) {

            alert("Please enter a message!");

            return;

        }



        // Create the data object with a timestamp

        const noticeData = {

            content: msg,

            timestamp: new Date().toLocaleString('en-IN', { 

                day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' 

            })

        };



        try {

            const res = await fetch('/api/admin/update-notice', {

                method: 'POST',

                headers: { 

                    'Content-Type': 'application/json' // CRITICAL: Tells Java to expect JSON

                },

                body: JSON.stringify(noticeData)

            });

            if (res.ok) {

                statusEl.innerHTML = `<span class="text-success fw-bold"><i class="bi bi-check-circle-fill"></i> Notice posted successfully!</span>`;

                document.getElementById('noticeInput').value = ""; // Clear the box

            } else {

                statusEl.innerHTML = `<span class="text-danger fw-bold">Error: Server rejected the request.</span>`;

            }

        } catch (e) {

            statusEl.innerHTML = `<span class="text-danger fw-bold">Network error! Check your backend.</span>`;

        }

    }



    async function clearNotice() {

        if(!confirm("Are you sure you want to clear the announcement?")) return;

        

        try {

            await fetch('/api/admin/update-notice', {

                method: 'POST',

                headers: { 'Content-Type': 'application/json' },

                body: JSON.stringify({ content: "", timestamp: "" })

            });

            alert("Notice cleared for everyone.");

        } catch (e) { console.error(e); }

    }

    // 5. PROCESS FINAL PAYMENT

   window.processFinalPayment = async function(method) {

    const userId = document.getElementById('targetUserId').value;

    const name = document.getElementById('targetUserName').value;

    const amountStr = document.getElementById('netPayDisplay').innerText.replace('₹', '').replace(/,/g, '');

    const amount = parseFloat(amountStr);



    if(!confirm(`Confirm ${method} payment of ₹${amount} for ${name}?`)) return;



    try {

        const res = await fetch(`/api/salary/pay?userId=${userId}&method=${method}`, { method: 'POST' });

        if(res.ok) {

            // STEP 1: Run Auto-Backup in the background

            triggerAutoBackup(name);

            

            // STEP 2: Show the printable voucher

            showVoucher(name, amount, method);

            

            // STEP 3: Refresh the dashboard

            loadEmployees(); 

        }

    } catch (e) {

        alert("Server error during payment.");

    }

};

async function triggerAutoBackup(employeeName) {

    try {

        const res = await fetch('/api/salary/all-logs');

        const logs = await res.json();



        if (logs.length === 0) return;



        // Format data for Excel

        const data = logs.map(log => ({

            "Date": new Date(log.date).toLocaleDateString(),

            "Employee": log.user.name,

            "Type": log.type,

            "Amount": log.dailyAmount,

            "Note": log.note || "N/A"

        }));



        const ws = XLSX.utils.json_to_sheet(data);

        const wb = XLSX.utils.book_new();

        XLSX.utils.book_append_sheet(wb, ws, "Backup_Logs");



        // Filename includes the employee name and current date

        const fileName = `Backup_${employeeName}_${new Date().toISOString().split('T')[0]}.xlsx`;

        XLSX.writeFile(wb, fileName);

        

        console.log("Auto-backup completed for " + employeeName);

    } catch (e) {

        console.error("Backup failed", e);

    }

}



    // 6. VIEW SECTIONS & LOGS

  async function showSection(sectionId) {

    // Hide all possible sections

    const sections = ['employeeSection', 'logsSection', 'userManagementSection'];

    sections.forEach(id => {

        const el = document.getElementById(id);

        if (el) el.classList.add('d-none');

    });



    // Show the selected section

    const target = document.getElementById(sectionId);

    if (target) target.classList.remove('d-none');



    // Trigger data fetching based on section

    if (sectionId === 'userManagementSection') {

        loadAllUsers();

    } else if (sectionId === 'logsSection') {

        const now = new Date();

        const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

        const filterInput = document.getElementById('logMonthFilter');

        if (filterInput) {

            filterInput.value = currentMonth;

            fetchFilteredLogs();

        }

    } else if (sectionId === 'employeeSection') {

        loadEmployees();

    }

}



//1. Live Search within the Log Table

  function filterLogTable() {

      const query = document.getElementById('logSearch').value.toLowerCase();

      const rows = document.querySelectorAll('#logsTableBody tr');

      

      rows.forEach(row => {

          const text = row.innerText.toLowerCase();

          row.style.display = text.includes(query) ? "" : "none";

      });

  }



  // 2. Enhanced Fetch Function

  async function fetchFilteredLogs() {

      const monthInput = document.getElementById('logMonthFilter').value;

      if (!monthInput) return;

      const [year, month] = monthInput.split('-');

      const tbody = document.getElementById('logsTableBody');



      try {

          const res = await fetch(`/api/salary/logs/filter?month=${month}&year=${year}`);

          const logs = await res.json();

          

          let totalCr = 0; // Salary

          let totalDr = 0; // Advance + Payments



          tbody.innerHTML = logs.map(log => {

              const type = log.type || "PAYMENT";

              const isCr = type === 'SALARY';

              isCr ? (totalCr += log.dailyAmount) : (totalDr += log.dailyAmount);



              // Styling logic

              const badgeMap = {

                  'SALARY': 'bg-success-subtle text-success border-success',

                  'ADVANCE': 'bg-warning-subtle text-warning border-warning',

                  'PAYMENT': 'bg-primary-subtle text-primary border-primary'

              };



              return `

              <tr class="animate-row">

                  <td class="ps-4">

                      <div class="fw-bold">${new Date(log.date).toLocaleDateString('en-IN', {day: '2-digit', month: 'short'})}</div>

                      <div class="text-muted" style="font-size: 0.7rem;">${new Date(log.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>

                  </td>

                  <td>

                      <div class="fw-600">${log.user ? log.user.name : 'Deleted User'}</div>

                  </td>

                  <td>

                      <span class="badge border ${badgeMap[type] || 'bg-secondary'} px-3">

                          ${type}

                      </span>

                  </td>

                  <td class="fw-bold ${isCr ? 'text-success' : 'text-danger'}">

                      ${isCr ? '↑' : '↓'} ₹${log.dailyAmount.toLocaleString('en-IN')}

                  </td>

                  <td>

                      <div class="small text-dark">${log.note || '-'}</div>

                      ${log.method ? `<span class="badge bg-light text-muted border-0 p-0" style="font-size: 0.65rem;">Mode: ${log.method}</span>` : ''}

                  </td>

                  <td class="text-center">

                      <button class="btn btn-sm btn-light text-danger border shadow-sm" onclick="deleteTransaction(${log.id})">

                          <i class="bi bi-trash3"></i>

                      </button>

                  </td>

              </tr>`;

          }).join('');



          // Update Summary Cards

          document.getElementById('monthCredits').innerText = `₹${totalCr.toLocaleString('en-IN')}`;

          document.getElementById('monthDebits').innerText = `₹${totalDr.toLocaleString('en-IN')}`;

          document.getElementById('netOutflow').innerText = `₹${(totalCr + totalDr).toLocaleString('en-IN')}`;



      } catch (err) {

          tbody.innerHTML = '<tr><td colspan="6" class="text-center p-5 text-danger">Error connecting to server...</td></tr>';

      }

  }

//1. Live Preview (Kept the same)

async function uploadHomeMedia() {

    // 1. Get the values from the inputs

    const f1 = document.getElementById('adminFile1').files[0];

    const f2 = document.getElementById('adminFile2').files[0];

    const titleVal = document.getElementById('adminHeroTitle').value;

    const subtitleVal = document.getElementById('adminHeroSubtitle').value;

    

    // FIX: You were missing this line! 

    const aboutVal = document.getElementById('adminAboutText').value;



    const btn = document.getElementById('uploadBtn');



    // 2. Prepare the FormData

    const formData = new FormData();

    formData.append("photo1", f1);

    formData.append("photo2", f2);

    formData.append("title", titleVal);

    formData.append("subtitle", subtitleVal);

    

    // FIX: Use 'aboutVal' here

    formData.append("about", aboutVal); 



    // 3. Send to Server

    try {

        btn.disabled = true;

        const res = await fetch('/api/home/update-all', { method: 'POST', body: formData });

        if (res.ok) {

            Swal.fire('Success', 'Everything updated!', 'success');

        }

    } catch (err) {

        console.error(err);

    } finally {

        btn.disabled = false;

    }

}



// 5. Preview Logic (Already working, kept for reference)

function previewImage(input, previewId) {

    if (input.files && input.files[0]) {

        const reader = new FileReader();

        reader.onload = (e) => document.getElementById(previewId).src = e.target.result;

        reader.readAsDataURL(input.files[0]);

    }

}

/* //1. Live Preview Function

  function previewImage(input, previewId) {

      const file = input.files[0];

      if (file) {

          const reader = new FileReader();

          reader.onload = function(e) {

              document.getElementById(previewId).src = e.target.result;

          }

          reader.readAsDataURL(file);

      }

  }



  // 2. Upload Function

 async function uploadHomeMedia() {

    const f1 = document.getElementById('adminFile1').files[0];

    const f2 = document.getElementById('adminFile2').files[0];

    const btn = document.getElementById('uploadBtn');



    if (!f1 || !f2) return Swal.fire('Error', 'Please select both photos', 'warning');



    const formData = new FormData();

    formData.append("photo1", f1);

    formData.append("photo2", f2);



    btn.disabled = true;

    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Uploading...';



    try {

        const res = await fetch('/api/home/upload-photos', { method: 'POST', body: formData });

        if (res.ok) {

            Swal.fire('Success', 'Homepage banners updated!', 'success');

            // DO NOT use location.reload() here to prevent the refresh loop

        }

    } catch (err) {

        Swal.fire('Error', 'Upload failed', 'error');

    } finally {

        btn.disabled = false;

        btn.innerText = 'Apply Changes to Homepage';

    }

} */

  async function deleteTransaction(logId) {

        if (!confirm("Delete this transaction?")) return;

        try {

            const res = await fetch(`/api/salary/delete-log/${logId}`, { method: 'DELETE' });

            if (res.ok) {

                fetchFilteredLogs();

                loadEmployees();

            }

        } catch (err) { alert("Error deleting record."); }

    }

  async function updateImages() {

        const fileInput1 = document.getElementById('adminFile1');

        const fileInput2 = document.getElementById('adminFile2');

        

        // 1. Prepare the data

        const formData = new FormData();

        formData.append("photo1", fileInput1.files[0]);

        formData.append("photo2", fileInput2.files[0]);



        try {

            // 2. Send the update request

            const response = await fetch('/api/home/upload-photos', {

                method: 'POST',

                body: formData

            });



            if (response.ok) {

                Swal.fire('Updated!', 'Your homepage images are now live.', 'success');

                

                // 3. Update the preview images immediately without refreshing the page

                const timestamp = new Date().getTime();

                document.getElementById('banner1').src = `/api/home/photo/banner1.jpg?t=${timestamp}`;

                document.getElementById('banner2').src = `/api/home/photo/banner2.jpg?t=${timestamp}`;

            }

        } catch (error) {

            Swal.fire('Error', 'Could not update images.', 'error');

        }

    }



    // 7. EXPORTS & HELPERS

    async function exportEmployeeReport() {

        try {

            const res = await fetch('/api/users/all');

            const users = await res.json();

            const employees = users.filter(u => u.role === 'USER' || u.role === 'ROLE_USER');

            const reportData = employees.map(u => ({

                "Staff Name": u.name,

                "Net Payable": (u.totalEarned || 0) - (u.advanceAmount || 0)

            }));

            const ws = XLSX.utils.json_to_sheet(reportData);

            const wb = XLSX.utils.book_new();

            XLSX.utils.book_append_sheet(wb, ws, "Payroll");

            XLSX.writeFile(wb, "Payroll_Report.xlsx");

        } catch (e) { alert("Export failed."); }

    }

    function showVoucher(name, amount, method) {

        const receipt = document.getElementById('receiptContent');

        const form = document.getElementById('fundForm');

        const options = document.getElementById('paymentOptionsSection');

        

        // UI State: Hide form/options, show receipt

        if(form) form.classList.add('d-none');

        if(options) options.classList.add('d-none');

        receipt.classList.remove('d-none');



        document.getElementById('modalTitle').innerText = "Payment Receipt";



        receipt.innerHTML = `

            <div id="printableReceipt" class="p-3 border rounded">

                <div class="text-center mb-4">

                    <h4 class="fw-bold mb-0">SalaryPro</h4>

                    <small class="text-muted text-uppercase">Official Payment Voucher</small>

                </div>

                

                <div class="d-flex justify-content-between mb-2">

                    <span class="text-muted">Date:</span>

                    <span class="fw-bold">${new Date().toLocaleDateString()}</span>

                </div>

                <div class="d-flex justify-content-between mb-4">

                    <span class="text-muted">Paid To:</span>

                    <span class="fw-bold">${name}</span>

                </div>



                <div class="bg-light p-3 rounded mb-4 text-center">

                    <small class="text-muted d-block">Amount Settled</small>

                    <h2 class="fw-bold text-success mb-0">₹${amount.toLocaleString()}</h2>

                </div>



                <div class="row g-2 mb-4 small">

                    <div class="col-6 text-muted">Payment Mode:</div>

                    <div class="col-6 text-end fw-bold">${method}</div>

                    <div class="col-6 text-muted">Status:</div>

                    <div class="col-6 text-end text-success fw-bold">COMPLETED</div>

                </div>



                <div class="mt-4 pt-4 border-top text-center no-print">

                    <button class="btn btn-dark w-100 mb-2" onclick="window.print()">

                        <i class="bi bi-printer me-2"></i> Print Voucher

                    </button>

                    <button class="btn btn-link btn-sm text-muted w-100" data-bs-dismiss="modal">

                        Close

                    </button>

                </div>

            </div>

        `;

    }

    function logout() {

        localStorage.clear();

        window.location.href = 'login.html';

    }

</script>

</body>

</html>